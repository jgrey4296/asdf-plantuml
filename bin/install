#!/usr/bin/env bash
# https://asdf-vm.com/plugins/create.html#bin-install
# # Install a specified version
# install into ASDF_INSTALL_PATH
# shims will be created for anything in install_path/bin
# only place files in install path if success

set -euo pipefail

current_script_path=${BASH_SOURCE[0]}
plugin_dir=$(dirname "$(dirname "$current_script_path")")

# shellcheck source=./lib/utils.bash
source "${plugin_dir}/lib/utils.bash"

exec_script="#!/usr/bin/env bash
set -euo pipefail

if [[ \"\$#\" -eq 0 ]]; then
       java -jar ${ASDF_INSTALL_PATH}/bin/${TOOL_NAME}.jar -help
else
       java -jar ${ASDF_INSTALL_PATH}/bin/${TOOL_NAME}.jar \"\$@\"
fi"

echo "* Installing to: $ASDF_INSTALL_PATH"
[[ "$ASDF_INSTALL_TYPE" = "version" ]] || fail "asdf-$TOOL_NAME supports release installs only, not $ASDF_INSTALL_TYPE"

(
    mkdir -p "$ASDF_INSTALL_PATH/bin"
    cp -r "$ASDF_DOWNLOAD_PATH/${TOOL_NAME}.jar" "$ASDF_INSTALL_PATH/bin/"

    echo "* Creating Run Script"
    echo "$exec_script" > "$ASDF_INSTALL_PATH/bin/${TOOL_NAME}"
    chmod  +x "$ASDF_INSTALL_PATH/bin/${TOOL_NAME}"

    # tool_cmd="$(echo "$TOOL_TEST" | cut -d' ' -f1)"
    # "$ASDF_INSTALL_PATH/bin/${TOOL_NAME}" -version || fail "Expected $ASDF_INSTALL_PATH/bin/$tool_cmd to be executable."

    echo "* $TOOL_NAME $ASDF_INSTALL_VERSION installation was successful!"
) || (
    # rm -rf "$ASDF_INSTALL_PATH"
    fail "An error occurred while installing $TOOL_NAME $ASDF_INSTALL_VERSION."
)
